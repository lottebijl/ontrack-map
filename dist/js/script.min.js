const baseUrl="../dist",assetUrl="../dist/assets",mapsKey="AIzaSyDA9w9HOxuTsR8bVmnvQVDE6CJacA0uEQ0";var options={url:assetUrl+"/data/VenueJson.json",getValue:"venueName",list:{match:{enabled:!0}},theme:"square"};$("#name-search").easyAutocomplete(options),$(document).ready(function(){document.getElementById("store-locator")&&new StoreLocator($("#store-locator"))});class StoreLocator{constructor(e){this.$storeLocator=e,this.$results=this.$storeLocator.find(".results"),this.storesJsonEndpoint=assetUrl+"/data/VenueJson.json",this.map=new StoreMap(this),this.stores,this.shownStores,this.selected,this.currentLocation,this.filters={open_saterday:!1,has_atm:!1,open_in_evening:!1,has_pick_up_point:!1,query:""},this.fetchStores(),this.bindings()}bindings(){this.$storeLocator.on("click touchstart",".btn-locate",()=>{this.onGeoLocate()}),this.$storeLocator.on("click touchstart",".btn-search",()=>{this.onSearch()}),this.$storeLocator.on("keyup",".search-field",e=>{13===e.keyCode?this.onSearch():this.onQueryChanged(e)}),this.$storeLocator.on("keydown",".search-field",()=>{this.clearSearchKeyUpTimeout()}),this.$storeLocator.on("change","input.open-saterday",e=>{this.onOpenSaterdayChanged(e)}),this.$storeLocator.on("change","input.has-atm",e=>{this.onHasAtmChanged(e)}),this.$storeLocator.on("change","input.open-in-evening",e=>{this.onOpenInEveningChanged(e)}),this.$storeLocator.on("change","input.has-pick-up-point",e=>{this.onHasPickUpPointChanged(e)}),this.$storeLocator.on("click",".result",e=>{this.onSelected(e)})}fetchStores(){$.get(this.storesJsonEndpoint,e=>{this.onStoresFetched(e)})}renderRows(){let e=this.$results.find(".template"),t=(moment().format("dddd").toLowerCase(),parseInt(this.getParameterByName("fico")));if(this.stores.each(s=>{let i=e.clone().removeClass("hidden").removeClass("template");i.attr("id","id-"+s.id),i.find(".name").text(s.venueName),i.find(".city").html(s.venueCity+' <small class="distance"></small>'),i.find(".address").html(s.venueAddress),s.venueCategory&&("A"==s.venueCategory&&i.find(".capacity").html("minimaal 450 bezoekers"),"B"==s.venueCategory&&i.find(".capacity").html("minimaal 350 bezoekers"),"C"==s.venueCategory&&i.find(".capacity").html("tussen de 200-300 bezoekers")),s.id===t&&i.filter("#id-"+t).addClass("active"),i.find(".link-apotheek").attr("href",s.venueWebsite),this.$results.append(i)}),this.$storeLocator.find(".has-tooltip").tooltip(),this.$results.find(".active").length){let e=this.$results.find(".active");e.trigger("click");let t=e.offset().top-this.$results.offset().top+this.$results.scrollTop();this.$results[0].scrollTop=t}}renderReOrder(){this.stores.each(e=>{let t=$("#id-"+e.id);t.find(".distance").text("(+"+Math.round(10*e.distance)/10+" km)"),this.$results.append(t)})}filter(){this.stores.each(e=>{e.is_shown=!0})}displayResults(){this.shownStores=this.stores.filter(e=>{let t=$("#id-"+e.id);return t.toggleClass("hidden",!e.is_shown),this.selected&&t.toggleClass("active",this.selected.id===e.id),e.is_shown})}showAll(e){e=void 0===e||e,this.stores.each(t=>{t.is_shown=e})}hideAll(){this.showAll(!1)}select(e){this.selected=this.stores.firstWhere("id",e),this.selected.is_shown=!0,this.$storeLocator.find(".selected-store-id").val(e).trigger("change"),this.$storeLocator.find(".selected-store-name").val(this.selected.venueName).trigger("change"),this.map.select(e)}scrollTo(e){let t=$("#id-"+e).offset().top-this.$results.offset().top+this.$results.scrollTop();this.$results[0].scrollTop=t}setSearchKeyUpTimeout(){this.searchTimeout=setTimeout(()=>{this.onSearch()},500)}clearSearchKeyUpTimeout(){clearTimeout(this.searchTimeout)}calculateDistances(e){this.stores.each(function(t){t.setDistance(e)})}sortByDistance(){this.stores=this.stores.sortBy("distance"),this.renderReOrder()}onStoresFetched(e){this.stores=collect(e).transform(function(e){return new Store(e)}),this.map.setMarkers(this.stores),this.renderRows(),this.displayResults(),this.currentLocation&&this.onGeoLocationChanged(this.currentLocation)}onQueryChanged(e){this.filters.query=$(e.target).val().toLowerCase(),this.setSearchKeyUpTimeout()}onSearch(){this.clearSearchKeyUpTimeout(),this.filter(),this.displayResults(),this.map.showMarkers(this.shownStores.pluck("id")),this.filters.query.length>3&&this.map.onSearch(this.filters.query)}onOpenSaterdayChanged(e){this.filters.open_saterday=$(e.target).prop("checked"),this.onSearch()}onHasAtmChanged(e){this.filters.has_atm=$(e.target).prop("checked"),this.onSearch()}onOpenInEveningChanged(e){this.filters.open_in_evening=$(e.target).prop("checked"),this.onSearch()}onHasPickUpPointChanged(e){this.filters.has_pick_up_point=$(e.target).prop("checked"),this.$storeLocator.find("input.has-pick-up-point").prop("checked",this.filters.has_pick_up_point),this.onSearch()}onSelected(e){let t=$(e.target).hasClass("result")?$(e.target):$(e.target).parents(".result"),s=parseInt(t.attr("id").replace("id-",""));this.select(s),this.displayResults()}onSelectedById(e){this.select(e),this.displayResults(),this.scrollTo(e)}onSelectedByIds(e){this.stores.whereIn("id",e.toArray()).each(function(e){e.is_shown=!0}),this.scrollTo(e.first()),this.displayResults()}onGeoLocate(){this.map.goToGeoCenter()}onGeoLocationChanged(e){this.currentLocation=e,this.stores&&(this.calculateDistances(e),this.sortByDistance())}getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var s=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return s?s[2]?decodeURIComponent(s[2].replace(/\+/g," ")):"":null}}class StoreMap{constructor(e){this.center={lat:52.076544,lng:4.186362},this.geoCenter=this.center,this.markers=collect(),this.shownMarkers=collect(),this.shownIds=collect(),this.delegate=e,this.selected,this.currentLocationMarker,this.searchMarker,this.map,this.mapOptions,this.autocomplete,this.markerCluster,this.initMap()}initMap(){window.isMobile?this.mapOptions={center:this.center,zoom:9,scrollwheel:!1,navigationControl:!1,mapTypeControl:!1,scaleControl:!1,draggable:!1,disableDefaultUI:!0}:this.mapOptions={center:this.center,zoom:9},this.map=new google.maps.Map(document.getElementById("store-locator-map"),this.mapOptions),this.selected=new google.maps.Marker({position:null,map:this.map,icon:assetUrl+"/svg/marker-highlighted.svg",id:null}),this.searchMarker=new google.maps.Marker({position:null,map:this.map,icon:assetUrl+"/svg/marker-highlighted-small.svg"});let e=this;this.selected.addListener("click",function(){e.delegate.onSelectedById(this.id)}),this.initMarkerCluster(),this.initAutocomplete(),this.findGeoLocation()}initMarkerCluster(){this.markerCluster=new MarkerClusterer(this.map,[],{styles:Array(5).fill({textColor:"#fff",url:assetUrl+"/svg/marker-cluster.svg",textSize:14,height:37,width:30})}),google.maps.event.addListener(this.markerCluster,"clusterclick",e=>{let t=collect(e.getMarkers()).pluck("id");this.delegate.onSelectedByIds(t)})}initAutocomplete(){let e=window.isMobile?document.getElementById("location-search-mobile"):document.getElementById("location-search");this.autocomplete=new google.maps.places.Autocomplete(e,{types:["geocode"],componentRestrictions:{country:"nl"}}),this.autocomplete.addListener("place_changed",()=>{this.foundPlace()})}setMarkers(e){e.each(e=>{let t=new google.maps.Marker({position:{lat:e.venueLatitude,lng:e.venueLongitude},map:this.map,icon:assetUrl+"/svg/marker.svg",id:e.id}),s=this;t.addListener("click",function(){s.delegate.onSelectedById(this.id)}),this.markers.push(t)}),this.shownMarkers=this.markers,this.shownIds=this.shownMarkers.pluck("id"),this.clusterMarkers()}onSearch(e){if(console.log("onSearch query"+e),this.query==e||this.geocodeSearch)return;this.query=e;let t="https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(e)+"%20Nederland&key="+mapsKey;this.geocodeSearch=$.get(t).then(e=>{if("OK"==e.status&&e.results.length){let t=e.results[0];if(!t.geometry)return;this.center=t.geometry.location,this.searchMarker.setPosition(this.center),this.goToCenter(),void 0!==t.geometry.bounds&&this.goToBounds(t.geometry.bounds)}this.geocodeSearch=null})}foundPlace(){var e=this.autocomplete.getPlace();e.geometry&&(this.center={lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},this.searchMarker.setPosition(this.center),this.goToCenter())}goToGeoCenter(){this.center=this.geoCenter,this.goToCenter()}goToCenter(){this.map.setCenter(this.center),this.delegate.onGeoLocationChanged(this.center)}goToBounds(e){var t=new google.maps.LatLngBounds;t.extend(e.northeast),t.extend(e.southwest),this.map.fitBounds(t)}select(e){let t=this.markers.firstWhere("id",e);this.selected.id=t.id,this.selected.setPosition(t.position),this.map.setCenter(t.position),this.showMarkers(this.shownIds)}showMarkers(e){this.shownIds=e,this.shownMarkers=this.markers.filter(t=>{let s=!1===e.search(t.id)?null:this.map;return null!==this.selected&&this.selected.id===t.id&&(s=null),t.setMap(s),null!=s}),this.clusterMarkers()}clusterMarkers(){this.markerCluster.clearMarkers(),this.markerCluster.addMarkers(this.shownMarkers.toArray())}findGeoLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{this.geoLocationAvailable(e)},()=>{this.geoLocationNotAvailable()})}geoLocationAvailable(e){this.geoCenter={lat:e.coords.latitude,lng:e.coords.longitude},this.locatedInTheNetherlands(this.geoCenter)&&(this.center=this.geoCenter,this.currentLocationMarker=new GeolocationMarker(this.map),this.currentLocationMarker.setCircleOptions({fillColor:"#ddd",strokeColor:"#aaa",strokeWeight:1}),this.goToCenter()),this.biasAutocomplete()}geoLocationNotAvailable(){$(".btn-locate").prop("disabled",!0)}biasAutocomplete(){var e=new google.maps.Circle({center:this.center,radius:900});this.autocomplete.setBounds(e.getBounds())}locatedInTheNetherlands(e){let t=50.8869709,s=2.8961311,i=53.5953873,o=7.1915611;return e.lat>t&&e.lng>s&&e.lat<i&&e.lng<o}selectFirstOnEnter(e){var t=e.addEventListener;e.addEventListener=function(s,i){if("keydown"==s){var o=i;i=function(t){var s=$(".pac-item-selected").length>0;if(13==t.which&&!s){var i=$.Event("keydown",{keyCode:40,which:40});o.apply(e,[i])}o.apply(e,[t])}}t.apply(e,[s,i])}}}class Store{constructor(e){for(var t in this.id,this.venueName,this.venueWebsite,this.distance,this.is_shown=!0,e)this[t]=e[t]}setDistance(e){let t=.017453292519943295,s=Math.cos,i=.5-s((this.venueLatitude-e.lat)*t)/2+s(e.lat*t)*s(this.venueLatitude*t)*(1-s((this.venueLongitude-e.lng)*t))/2;this.distance=12742*Math.asin(Math.sqrt(i))}}
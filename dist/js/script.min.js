const baseUrl="../dist",assetUrl="../dist/assets",mapsKey="AIzaSyDA9w9HOxuTsR8bVmnvQVDE6CJacA0uEQ0";$(document).ready(function(){document.getElementById("store-locator")&&new StoreLocator($("#store-locator"))});class StoreLocator{constructor(t){this.$storeLocator=t,this.$results=this.$storeLocator.find(".results"),this.storesJsonEndpoint=assetUrl+"/data/PharmacyJson.json",this.map=new StoreMap(this),this.stores,this.shownStores,this.selected,this.currentLocation,this.filters={open_saterday:!1,has_atm:!1,open_in_evening:!1,has_pick_up_point:!1,query:""},this.fetchStores(),this.bindings()}bindings(){this.$storeLocator.on("click touchstart",".btn-locate",()=>{this.onGeoLocate()}),this.$storeLocator.on("click touchstart",".btn-search",()=>{this.onSearch()}),this.$storeLocator.on("keyup",".search-field",t=>{13===t.keyCode?this.onSearch():this.onQueryChanged(t)}),this.$storeLocator.on("keydown",".search-field",()=>{this.clearSearchKeyUpTimeout()}),this.$storeLocator.on("change","input.open-saterday",t=>{this.onOpenSaterdayChanged(t)}),this.$storeLocator.on("change","input.has-atm",t=>{this.onHasAtmChanged(t)}),this.$storeLocator.on("change","input.open-in-evening",t=>{this.onOpenInEveningChanged(t)}),this.$storeLocator.on("change","input.has-pick-up-point",t=>{this.onHasPickUpPointChanged(t)}),this.$storeLocator.on("click",".result",t=>{this.onSelected(t)})}fetchStores(){$.get(this.storesJsonEndpoint,t=>{this.onStoresFetched(t)})}renderRows(){let t=this.$results.find(".template"),e=moment().format("dddd").toLowerCase(),s=parseInt(this.getParameterByName("fico"));if(this.stores.each(i=>{let o=t.clone().removeClass("hidden").removeClass("template"),r=i.opening_hours[e].afternoon_close;o.attr("id","id-"+i.id),o.find(".name").text(i.name),o.find(".city").html(i.location.city+' <small class="distance"></small>'),i.id===s&&o.filter("#id-"+s).addClass("active"),null===r?o.find(".opening-hrs").text("Vandaag gesloten"):o.find(".opening-hrs").text("Vandaag open tot "+r),o.find(".link-apotheek").attr("href",i.url),i.has_skin_care||o.find(".has-skin-care").remove(),i.has_atm||o.find(".has-atm").remove(),i.has_pick_up_point||o.find(".has-pick-up-point").remove(),this.$results.append(o)}),this.$storeLocator.find(".has-tooltip").tooltip(),this.$results.find(".active").length){let t=this.$results.find(".active");t.trigger("click");let e=t.offset().top-this.$results.offset().top+this.$results.scrollTop();this.$results[0].scrollTop=e}}renderReOrder(){this.stores.each(t=>{let e=$("#id-"+t.id);e.find(".distance").text("(+"+Math.round(10*t.distance)/10+" km)"),this.$results.append(e)})}filter(){this.stores.each(t=>{t.is_shown=!0,(this.filters.open_saterday&&!t.open_saterday||this.filters.has_atm&&!t.has_atm||this.filters.open_in_evening&&!t.open_in_evening||this.filters.has_pick_up_point&&!t.has_pick_up_point)&&(t.is_shown=!1)})}displayResults(){this.shownStores=this.stores.filter(t=>{let e=$("#id-"+t.id);return e.toggleClass("hidden",!t.is_shown),this.selected&&e.toggleClass("active",this.selected.id===t.id),t.is_shown})}showAll(t){t=void 0===t||t,this.stores.each(e=>{e.is_shown=t})}hideAll(){this.showAll(!1)}select(t){this.selected=this.stores.firstWhere("id",t),this.selected.is_shown=!0,this.$storeLocator.find(".selected-store-id").val(t).trigger("change"),this.$storeLocator.find(".selected-store-name").val(this.selected.name).trigger("change"),this.$storeLocator.find(".selected-store-linscriptum").val(this.selected.linscriptum).trigger("change"),this.map.select(t)}scrollTo(t){let e=$("#id-"+t).offset().top-this.$results.offset().top+this.$results.scrollTop();this.$results[0].scrollTop=e}setSearchKeyUpTimeout(){this.searchTimeout=setTimeout(()=>{this.onSearch()},500)}clearSearchKeyUpTimeout(){clearTimeout(this.searchTimeout)}calculateDistances(t){this.stores.each(function(e){e.setDistance(t)})}sortByDistance(){this.stores=this.stores.sortBy("distance"),this.renderReOrder()}onStoresFetched(t){this.stores=collect(t).transform(function(t){return new Store(t)}),this.map.setMarkers(this.stores),this.renderRows(),this.displayResults(),this.currentLocation&&this.onGeoLocationChanged(this.currentLocation)}onQueryChanged(t){this.filters.query=$(t.target).val().toLowerCase(),this.$storeLocator.find(".search-field").val(this.filters.query),this.setSearchKeyUpTimeout()}onSearch(){this.clearSearchKeyUpTimeout(),this.filter(),this.displayResults(),this.map.showMarkers(this.shownStores.pluck("id")),this.filters.query.length>3&&this.map.onSearch(this.filters.query)}onOpenSaterdayChanged(t){this.filters.open_saterday=$(t.target).prop("checked"),this.onSearch()}onHasAtmChanged(t){this.filters.has_atm=$(t.target).prop("checked"),this.onSearch()}onOpenInEveningChanged(t){this.filters.open_in_evening=$(t.target).prop("checked"),this.onSearch()}onHasPickUpPointChanged(t){this.filters.has_pick_up_point=$(t.target).prop("checked"),this.$storeLocator.find("input.has-pick-up-point").prop("checked",this.filters.has_pick_up_point),this.onSearch()}onSelected(t){let e=$(t.target).hasClass("result")?$(t.target):$(t.target).parents(".result"),s=parseInt(e.attr("id").replace("id-",""));this.select(s),this.displayResults()}onSelectedById(t){this.select(t),this.displayResults(),this.scrollTo(t)}onSelectedByIds(t){this.stores.whereIn("id",t.toArray()).each(function(t){t.is_shown=!0}),this.scrollTo(t.first()),this.displayResults()}onGeoLocate(){this.map.goToGeoCenter()}onGeoLocationChanged(t){this.currentLocation=t,this.stores&&(this.calculateDistances(t),this.sortByDistance())}getParameterByName(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var s=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return s?s[2]?decodeURIComponent(s[2].replace(/\+/g," ")):"":null}}class StoreMap{constructor(t){this.center={lat:52.076544,lng:4.186362},this.geoCenter=this.center,this.markers=collect(),this.shownMarkers=collect(),this.shownIds=collect(),this.delegate=t,this.selected,this.currentLocationMarker,this.searchMarker,this.map,this.mapOptions,this.autocomplete,this.markerCluster,this.initMap()}initMap(){window.isMobile?this.mapOptions={center:this.center,zoom:9,scrollwheel:!1,navigationControl:!1,mapTypeControl:!1,scaleControl:!1,draggable:!1,disableDefaultUI:!0}:this.mapOptions={center:this.center,zoom:9},this.map=new google.maps.Map(document.getElementById("store-locator-map"),this.mapOptions),this.selected=new google.maps.Marker({position:null,map:this.map,icon:assetUrl+"/svg/marker-highlighted.svg",id:null}),this.searchMarker=new google.maps.Marker({position:null,map:this.map,icon:assetUrl+"/svg/marker-highlighted-small.svg"});let t=this;this.selected.addListener("click",function(){t.delegate.onSelectedById(this.id)}),this.initMarkerCluster(),this.initAutocomplete(),this.findGeoLocation()}initMarkerCluster(){this.markerCluster=new MarkerClusterer(this.map,[],{styles:Array(5).fill({textColor:"#fff",url:assetUrl+"/svg/marker-cluster.svg",textSize:14,height:37,width:30})}),google.maps.event.addListener(this.markerCluster,"clusterclick",t=>{let e=collect(t.getMarkers()).pluck("id");this.delegate.onSelectedByIds(e)})}initAutocomplete(){let t=window.isMobile?document.getElementById("location-search-mobile"):document.getElementById("location-search");this.autocomplete=new google.maps.places.Autocomplete(t,{types:["geocode"],componentRestrictions:{country:"nl"}}),this.autocomplete.addListener("place_changed",()=>{this.foundPlace()})}setMarkers(t){t.each(t=>{let e=new google.maps.Marker({position:{lat:t.location.latitude,lng:t.location.longitude},map:this.map,icon:assetUrl+"/svg/marker.svg",id:t.id}),s=this;e.addListener("click",function(){s.delegate.onSelectedById(this.id)}),this.markers.push(e)}),this.shownMarkers=this.markers,this.shownIds=this.shownMarkers.pluck("id"),this.clusterMarkers()}onSearch(t){if(this.query==t||this.geocodeSearch)return;this.query=t;let e="https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURI(t)+"%20Nederland&key="+mapsKey;this.geocodeSearch=$.get(e).then(t=>{if("OK"==t.status&&t.results.length){let e=t.results[0];if(!e.geometry)return;this.center=e.geometry.location,this.searchMarker.setPosition(this.center),this.goToCenter(),void 0!==e.geometry.bounds&&this.goToBounds(e.geometry.bounds)}this.geocodeSearch=null})}foundPlace(){var t=this.autocomplete.getPlace();t.geometry&&(this.center={lat:t.geometry.location.lat(),lng:t.geometry.location.lng()},this.searchMarker.setPosition(this.center),this.goToCenter())}goToGeoCenter(){this.center=this.geoCenter,this.goToCenter()}goToCenter(){this.map.setCenter(this.center),this.delegate.onGeoLocationChanged(this.center)}goToBounds(t){var e=new google.maps.LatLngBounds;e.extend(t.northeast),e.extend(t.southwest),this.map.fitBounds(e)}select(t){let e=this.markers.firstWhere("id",t);this.selected.id=e.id,this.selected.setPosition(e.position),this.map.setCenter(e.position),this.showMarkers(this.shownIds)}showMarkers(t){this.shownIds=t,this.shownMarkers=this.markers.filter(e=>{let s=!1===t.search(e.id)?null:this.map;return null!==this.selected&&this.selected.id===e.id&&(s=null),e.setMap(s),null!=s}),this.clusterMarkers()}clusterMarkers(){this.markerCluster.clearMarkers(),this.markerCluster.addMarkers(this.shownMarkers.toArray())}findGeoLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(t=>{this.geoLocationAvailable(t)},()=>{this.geoLocationNotAvailable()})}geoLocationAvailable(t){this.geoCenter={lat:t.coords.latitude,lng:t.coords.longitude},this.locatedInTheNetherlands(this.geoCenter)&&(this.center=this.geoCenter,this.currentLocationMarker=new GeolocationMarker(this.map),this.currentLocationMarker.setCircleOptions({fillColor:"#ddd",strokeColor:"#aaa",strokeWeight:1}),this.goToCenter()),this.biasAutocomplete()}geoLocationNotAvailable(){$(".btn-locate").prop("disabled",!0)}biasAutocomplete(){var t=new google.maps.Circle({center:this.center,radius:900});this.autocomplete.setBounds(t.getBounds())}locatedInTheNetherlands(t){let e=50.8869709,s=2.8961311,i=53.5953873,o=7.1915611;return t.lat>e&&t.lng>s&&t.lat<i&&t.lng<o}selectFirstOnEnter(t){var e=t.addEventListener;t.addEventListener=function(s,i){if("keydown"==s){var o=i;i=function(e){var s=$(".pac-item-selected").length>0;if(13==e.which&&!s){var i=$.Event("keydown",{keyCode:40,which:40});o.apply(t,[i])}o.apply(t,[e])}}e.apply(t,[s,i])}}}class Store{constructor(t){for(var e in this.id,this.name,this.linscriptum,this.open_saterday,this.open_in_evening,this.has_atm,this.has_pick_up_point,this.has_skin_care,this.url,this.location,this.opening_hours,this.distance,this.is_shown=!0,t)this[e]=t[e]}setDistance(t){let e=.017453292519943295,s=Math.cos,i=.5-s((this.location.latitude-t.lat)*e)/2+s(t.lat*e)*s(this.location.latitude*e)*(1-s((this.location.longitude-t.lng)*e))/2;this.distance=12742*Math.asin(Math.sqrt(i))}}